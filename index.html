<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø­Ø±Ø¨ Pro Mobile</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --accent: #764ba2;
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #2d3748;
            --text-sub: #718096;
            --border: #e2e8f0;
            --success: #48bb78;
            --danger: #f56565;
            --radius: 16px;
        }

        [data-theme="dark"] {
            --primary: #7f9cf5;
            --primary-dark: #667eea;
            --accent: #5a67d8;
            --bg-body: #1a202c;
            --bg-card: #2d3748;
            --text-main: #f7fafc;
            --text-sub: #a0aec0;
            --border: #4a5568;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª */
            transition: background 0.3s;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 20px 15px;
            padding-top: max(20px, env(safe-area-inset-top)); /* Ø¯Ø¹Ù… Ù†ÙˆØªØ´ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
            text-align: center;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        /* --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs) --- */
        .tabs-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-body);
            padding: 10px 0;
            margin: 0 10px;
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 5px;
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„ÙØ§ÙŠØ±ÙÙˆÙƒØ³ */
        }
        
        .tabs::-webkit-scrollbar { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙƒØ±ÙˆÙ… */

        .tab {
            flex: 0 0 auto;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-sub);
            font-weight: 600;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ --- */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .tab-content {
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        .tab-content.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª --- */
        .input-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-sub);
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù„Ù€ 16px Ù„Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙˆÙ… ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-body);
            color: var(--text-main);
            font-size: 16px; 
            transition: border-color 0.3s;
            appearance: none;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .preview-box {
            font-size: 0.8rem;
            color: var(--primary);
            margin-top: 6px;
            display: flex;
            justify-content: flex-end;
        }

        /* --- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª --- */
        .grid-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
        }

        .select-item {
            background: var(--bg-body);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .select-item.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
        }

        .select-item span { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .select-item small { font-size: 0.7rem; font-weight: bold; }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }

        button.btn-lg {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        button.btn-lg:active { transform: scale(0.98); }

        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .btn-secondary { background: var(--bg-card); color: var(--text-main); border: 2px solid var(--border); }
        .btn-success { background: var(--success); color: white; }

        /* --- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: var(--bg-body);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-val { font-size: 1.3rem; font-weight: bold; color: var(--text-main); }
        .stat-lbl { font-size: 0.8rem; color: var(--text-sub); margin-top: 5px; }

        /* --- Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© --- */
        .vs-badge {
            background: var(--text-sub);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: -10px auto 10px;
            border: 4px solid var(--bg-card);
            position: relative;
            z-index: 2;
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
        <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø­Ø±Ø¨ Pro</h1>
        <p style="opacity: 0.8; font-size: 0.85rem;">Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ v2.0</p>
    </div>

    <div class="tabs-wrapper">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('calculator')">ğŸ¯ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</button>
            <button class="tab" onclick="switchTab('compare')">âš”ï¸ Ù…Ù‚Ø§Ø±Ù†Ø©</button>
            <button class="tab" onclick="switchTab('saved')">ğŸ’¾ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª</button>
            <button class="tab" onclick="switchTab('charts')">ğŸ“Š Ø§Ù„Ø±Ø³ÙˆÙ…</button>
        </div>
    </div>

    <div class="container">
        
        <div id="calculator" class="tab-content active">
            
            <div class="card">
                <h2>ğŸ—¡ï¸ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ù‡Ø§Ø¬Ù…</h2>
                
                <div class="input-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <select id="attackerType">
                        <option value="tank">ğŸŸ« Ø¯Ø¨Ø§Ø¨Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                        <option value="plane">âœˆï¸ Ø·Ø§Ø¦Ø±Ø© Ù…Ù‚Ø§ØªÙ„Ø©</option>
                        <option value="missile">ğŸš€ Ù…Ù†ØµØ© ØµÙˆØ§Ø±ÙŠØ®</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ù‚ÙˆØ© Ø§Ù„Ù‡Ø¬ÙˆÙ…</label>
                    <input type="text" id="attack" value="65.2K" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 100K Ø£Ùˆ 1M">
                    <div class="preview-box">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="attackValue">65,200</span></div>
                </div>

                <div class="input-group">
                    <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø¬ÙˆÙ… (Ø§Ù„ØªØ±Ù‚ÙŠØ©)</label>
                    <div class="grid-select">
                        <div class="select-item selected" onclick="selectStars(0, this)"><span>â­</span><small>+30%</small></div>
                        <div class="select-item" onclick="selectStars(1, this)"><span>2â­</span><small>+70%</small></div>
                        <div class="select-item" onclick="selectStars(2, this)"><span>3â­</span><small>+120%</small></div>
                        <div class="select-item" onclick="selectStars(3, this)"><span>4â­</span><small>+185%</small></div>
                        <div class="select-item" onclick="selectStars(4, this)"><span>5â­</span><small>+270%</small></div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</label>
                    <div class="grid-select" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="select-item selected" onclick="selectSkill(0, this)"><span>âš”ï¸</span><small>Ø¹Ø§Ø¯ÙŠØ©</small></div>
                        <div class="select-item" onclick="selectSkill(1, this)"><span>ğŸ”¥</span><small>Ø®Ø§ØµØ©</small></div>
                        <div class="select-item" onclick="selectSkill(2, this)"><span>ğŸ’¥</span><small>Ù†Ù‡Ø§Ø¦ÙŠØ©</small></div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="input-group" style="margin:0;">
                        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø±Ø¬Ø© %</label>
                        <input type="number" id="critChance" value="20" inputmode="numeric">
                    </div>
                    <div class="input-group" style="margin:0;">
                        <label>Ø¶Ø±Ø± Ø§Ù„Ø­Ø±Ø¬Ø© %</label>
                        <input type="number" id="critDamage" value="150" inputmode="numeric">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ›¡ï¸ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø¯Ø§ÙØ¹</h2>
                <div class="input-group">
                    <label>Ù†Ù‚Ø§Ø· Ø§Ù„ØµØ­Ø© (HP)</label>
                    <input type="text" id="health" value="1.4M" inputmode="decimal">
                    <div class="preview-box">Ø§Ù„Ù‚ÙŠÙ…Ø©: <span id="healthValue">1,400,000</span></div>
                </div>

                <div class="stats-grid">
                    <div class="input-group" style="margin:0;">
                        <label>Ø§Ù„Ø¯ÙØ§Ø¹</label>
                        <input type="text" id="defense" value="8.4K" inputmode="decimal">
                    </div>
                    <div class="input-group" style="margin:0;">
                        <label>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© %</label>
                        <input type="number" id="resistance" value="10" inputmode="numeric">
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-lg btn-primary" onclick="simulateBattle()">
                    <span>ğŸ¯</span> Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                </button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-lg btn-secondary" onclick="saveCalculation()">ğŸ’¾ Ø­ÙØ¸</button>
                    <button class="btn-lg btn-success" onclick="shareAsImage()">ğŸ“¸ ØµÙˆØ±Ø©</button>
                </div>
            </div>

            <div id="results" style="display: none; margin-top: 25px;"></div>
        </div>

        <div id="compare" class="tab-content">
            <div class="card">
                <h2>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</h2>
                <input type="text" id="comp1Attack" placeholder="Ø§Ù„Ù‡Ø¬ÙˆÙ…" value="65.2K" class="input-group">
                <select id="comp1Stars" style="width:100%">
                    <option value="0">â­ 1 Ù†Ø¬Ù…Ø©</option>
                    <option value="1">â­â­ 2 Ù†Ø¬Ù…Ø©</option>
                    <option value="2">â­â­â­ 3 Ù†Ø¬ÙˆÙ…</option>
                    <option value="3">â­â­â­â­ 4 Ù†Ø¬ÙˆÙ…</option>
                    <option value="4">â­â­â­â­â­ 5 Ù†Ø¬ÙˆÙ…</option>
                </select>
            </div>

            <div class="vs-badge">VS</div>

            <div class="card">
                <h2>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</h2>
                <input type="text" id="comp2Attack" placeholder="Ø§Ù„Ù‡Ø¬ÙˆÙ…" value="70K" class="input-group">
                <select id="comp2Stars" style="width:100%">
                    <option value="0">â­ 1 Ù†Ø¬Ù…Ø©</option>
                    <option value="1">â­â­ 2 Ù†Ø¬Ù…Ø©</option>
                    <option value="2">â­â­â­ 3 Ù†Ø¬ÙˆÙ…</option>
                    <option value="3">â­â­â­â­ 4 Ù†Ø¬ÙˆÙ…</option>
                    <option value="4">â­â­â­â­â­ 5 Ù†Ø¬ÙˆÙ…</option>
                </select>
            </div>

            <button class="btn-lg btn-primary" onclick="compareUnits()">ğŸ” Ù‚Ø§Ø±Ù† Ø§Ù„Ø¢Ù†</button>
            <div id="compareResults" style="margin-top: 20px;"></div>
        </div>

        <div id="saved" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
                <div id="savedList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <div id="charts" class="tab-content">
            <div class="card">
                <h2>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</h2>
                <div style="height: 250px; position: relative;">
                    <canvas id="skillChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª</h2>
                <div style="height: 250px; position: relative;">
                    <canvas id="upgradeChart"></canvas>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ØªØºÙŠØ±Ø§Øª ---
    let selectedStarLevel = 0;
    let selectedSkillType = 0;
    const starBonuses = [0.30, 0.70, 1.20, 1.85, 2.70];
    const skillMultipliers = [1.0, 3.45, 6.05];
    let currentTheme = 'light';
    let skillChart, upgradeChart;

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function parseValue(str) {
        if (!str) return 0;
        str = String(str).toUpperCase().trim();
        if (str.includes('M')) return parseFloat(str.replace('M', '')) * 1000000;
        if (str.includes('K')) return parseFloat(str.replace('K', '')) * 1000;
        return parseFloat(str.replace(/,/g, '')) || 0;
    }

    function formatNumber(num) { return num.toLocaleString('en-US'); }
    function formatCompact(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    // --- Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function selectStars(level, el) {
        selectedStarLevel = level;
        el.parentElement.querySelectorAll('.select-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        updatePreview();
    }

    function selectSkill(type, el) {
        selectedSkillType = type;
        el.parentElement.querySelectorAll('.select-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
        
        // ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø· Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØµÙ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
        event.target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

        if (tabId === 'saved') loadSaved();
        if (tabId === 'charts') updateCharts();
    }

    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        document.querySelector('.theme-toggle').textContent = currentTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        if(skillChart || upgradeChart) setTimeout(updateCharts, 100);
    }

    // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙÙˆØ±ÙŠ ---
    function updatePreview() {
        const attack = parseValue(document.getElementById('attack').value);
        const health = parseValue(document.getElementById('health').value);
        
        document.getElementById('attackValue').textContent = formatNumber(attack);
        document.getElementById('healthValue').textContent = formatNumber(health);
    }

    // Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
    ['attack', 'health', 'defense'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
    });

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ---
    function simulateBattle() {
        const attack = parseValue(document.getElementById('attack').value);
        const defense = parseValue(document.getElementById('defense').value);
        let health = parseValue(document.getElementById('health').value);
        const critChance = parseFloat(document.getElementById('critChance').value) / 100;
        const critDamage = parseFloat(document.getElementById('critDamage').value) / 100;
        const resistance = parseFloat(document.getElementById('resistance').value) / 100;

        const baseDmg = (attack - defense) * (1 + starBonuses[selectedStarLevel]) * skillMultipliers[selectedSkillType] * (1 - resistance);
        
        let turns = 0, totalDmg = 0, crits = 0;
        let logs = [];

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø³Ø±ÙŠØ¹Ø©
        while (health > 0 && turns < 2000) {
            turns++;
            const isCrit = Math.random() < critChance;
            let dmg = Math.max(1, isCrit ? baseDmg * critDamage : baseDmg);
            health -= dmg;
            totalDmg += dmg;
            if (isCrit) crits++;
            
            if (turns <= 5 || health <= 0) { // Ù†Ø³Ø¬Ù„ ÙÙ‚Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù„Ù„ØªØ®ÙÙŠÙ
                logs.push({ t: turns, d: dmg, c: isCrit, h: Math.max(0, health) });
            }
        }

        const resultsHTML = `
            <div class="card" style="border-top: 4px solid var(--success);">
                <h3 style="text-align: center; margin-bottom: 15px;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙƒØ©</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-val">${turns}</div>
                        <div class="stat-lbl">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val">${formatCompact(totalDmg)}</div>
                        <div class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±Ø±</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val">${crits}</div>
                        <div class="stat-lbl">Ø¶Ø±Ø¨Ø§Øª Ø­Ø±Ø¬Ø©</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val">${formatCompact(totalDmg/turns)}</div>
                        <div class="stat-lbl">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¶Ø±Ø±</div>
                    </div>
                </div>
            </div>
        `;
        
        const resDiv = document.getElementById('results');
        resDiv.innerHTML = resultsHTML;
        resDiv.style.display = 'block';
        resDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // --- Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ---
    function compareUnits() {
        const getPower = (idAtk, idStar) => {
            const atk = parseValue(document.getElementById(idAtk).value);
            const stars = parseInt(document.getElementById(idStar).value);
            return atk * (1 + starBonuses[stars]);
        };

        const p1 = getPower('comp1Attack', 'comp1Stars');
        const p2 = getPower('comp2Attack', 'comp2Stars');
        const diff = Math.abs(p1 - p2);
        const winner = p1 > p2 ? 'Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Ø§Ù„Ø«Ø§Ù†ÙŠØ©';

        document.getElementById('compareResults').innerHTML = `
            <div class="card" style="text-align: center; background: rgba(102, 126, 234, 0.1);">
                <h3>ğŸ† Ø§Ù„ÙˆØ­Ø¯Ø© ${winner} Ø£Ù‚ÙˆÙ‰</h3>
                <p>Ø§Ù„ÙØ±Ù‚: <strong>${formatCompact(diff)}</strong> Ù†Ù‚Ø·Ø© Ø¶Ø±Ø±</p>
                <div style="font-size: 0.8rem; margin-top: 10px; color: var(--text-sub);">
                    (Ø§Ù„Ø£ÙˆÙ„Ù‰: ${formatCompact(p1)}) vs (Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ${formatCompact(p2)})
                </div>
            </div>
        `;
    }

    // --- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
    function updateCharts() {
        const base = 100; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø±Ø³Ù…
        const textColor = currentTheme === 'dark' ? '#cbd5e0' : '#4a5568';

        // Ø±Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª
        const ctx1 = document.getElementById('skillChart');
        if (skillChart) skillChart.destroy();
        skillChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Ø¹Ø§Ø¯ÙŠØ©', 'Ø®Ø§ØµØ©', 'Ù†Ù‡Ø§Ø¦ÙŠØ©'],
                datasets: [{
                    label: 'Ù‚ÙˆØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©',
                    data: skillMultipliers.map(m => m * 100),
                    backgroundColor: ['#667eea', '#ed64a6', '#ecc94b'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: textColor } },
                    y: { ticks: { color: textColor } }
                }
            }
        });

        // Ø±Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª
        const ctx2 = document.getElementById('upgradeChart');
        if (upgradeChart) upgradeChart.destroy();
        upgradeChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: ['â­', '2â­', '3â­', '4â­', '5â­'],
                datasets: [{
                    label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚ÙˆØ©',
                    data: starBonuses.map(b => (1 + b) * 100),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: textColor } },
                    y: { ticks: { color: textColor } }
                }
            }
        });
    }

    // --- Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ---
    function saveCalculation() {
        const saved = JSON.parse(localStorage.getItem('warCalc_v2') || '[]');
        saved.unshift({
            date: new Date().toLocaleDateString('ar'),
            atk: document.getElementById('attack').value,
            hp: document.getElementById('health').value
        });
        localStorage.setItem('warCalc_v2', JSON.stringify(saved.slice(0, 10)));
        alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }

    function loadSaved() {
        const saved = JSON.parse(localStorage.getItem('warCalc_v2') || '[]');
        const list = document.getElementById('savedList');
        if(saved.length === 0) list.innerHTML = '<p style="text-align:center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>';
        else {
            list.innerHTML = saved.map(item => `
                <div style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; display: flex; justify-content: space-between;">
                    <span>ğŸ“… ${item.date}</span>
                    <span>âš”ï¸ ${item.atk}</span>
                </div>
            `).join('');
        }
    }

    function shareAsImage() {
        alert('Ø³ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù„Ù†ØªØ§Ø¦Ø¬...');
        // ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ html2canvas Ù‡Ù†Ø§
    }
    
    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    updatePreview();
</script>

</body>
</html>
